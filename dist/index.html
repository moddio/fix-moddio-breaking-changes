<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload JSON</title>
</head>

<body>
  <!-- File Upload Button -->
  <input type="file" id="uploadJson" accept=".json" />

  <div style="margin: 1em 0;">
    <label>
      <input type="checkbox" id="fixScaleWorld" checked>
      fix scale (use world unit)
    </label>
    <br>
    <label>
      <input type="checkbox" id="useRapier2d" checked>
      use rapier2d
    </label>
    <br>
  </div>

  <button onclick="handleJson()">Download</button>
  <label>Warning: this tool can't auto fix the value in script</label>

  <script src="bundle.js" type="text/javascript"></script>
  <script>
    let jsonObject = null;


    // Function to handle the uploaded JSON file and apply selected fixes
    function handleJson() {
      const fileInput = document.getElementById('uploadJson');
      const file = fileInput.files[0];

      if (!file) {
        alert('Please select a JSON file first!');
        return;
      }

      const fixScaleWorld = document.getElementById('fixScaleWorld').checked;
      // const fixScalePixel = document.getElementById('fixScalePixel').checked;
      // const fixFixture = document.getElementById('fixFixture').checked;
      // const moveUpHalfDepth = document.getElementById('moveUpHalfDepth').checked;
      const useRapier2d = document.getElementById('useRapier2d').checked;
      const reader = new FileReader();

      const { fixScale, removeUnwantedProperties } = window.fixes;

      reader.onload = function (event) {
        try {
          jsonObject = JSON.parse(event.target.result);
          let obj = JSON.parse(JSON.stringify(jsonObject)); // deep clone

          let prefixParts = [];

          // Only one of fixScaleWorld or fixScalePixel can be checked
          if (fixScaleWorld) {
            obj = fixScale(obj, false);
            prefixParts.push('fixed_scale(world_unit)');
          } 

          if (useRapier2d) {
            obj.physicsEngine = 'rapier2d';
            if (obj.clientPhysicsEngine !== '') {
              obj.clientPhysicsEngine = 'rapier2d';
            }
          }

          // Always remove unwanted properties
          obj = removeUnwantedProperties(obj);
          prefixParts.push('remove_unwanted_properties');

          const prefix = prefixParts.join('_');
          downloadJson(obj, `${prefix}_${file.name}`);
        } catch (error) {
          console.error('Error parsing JSON:', error);
          alert('Invalid JSON file!');
        }
      };
      reader.readAsText(file);
    }

    // Function to download the JSON object as a file
    function downloadJson(jsonObj, name) {
      const jsonString = JSON.stringify(jsonObj, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>

</html>