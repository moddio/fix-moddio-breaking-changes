<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload JSON</title>
</head>

<body>
  <!-- File Upload Button -->
  <input type="file" id="uploadJson" accept=".json" />
  <label>
    <input type="checkbox" id="fixScaleCheckbox" />
    fix scale (use world unit)
  </label>
  <button onclick="handleCombined()">make g</button>

  <script src="bundle.js" type="text/javascript"></script>
  <script>
    let jsonObject = null;

    // Combined handler for "make g" button, applies fixScale if checkbox is checked, then removeUnwantedProperties
    function handleCombined() {
      const fileInput = document.getElementById('uploadJson');
      const file = fileInput.files[0];
      const fixScaleChecked = document.getElementById('fixScaleCheckbox').checked;

      if (!file) {
        alert('Please select a JSON file first!');
        return;
      }

      const reader = new FileReader();
      const { fixScale, removeUnwantedProperties } = window.fixes;

      reader.onload = function (event) {
        try {
          jsonObject = JSON.parse(event.target.result);
          let processed = jsonObject;
          let prefix = '';

          if (fixScaleChecked) {
            processed = fixScale(processed, false);
            prefix += 'fixed_scale(world_unit)_';
          }

          processed = removeUnwantedProperties(processed);
          prefix += 'remove_unwanted_properties_';

          downloadJson(processed, `${prefix}${file.name}`);
        } catch (error) {
          console.error('Error parsing JSON:', error);
          alert('Invalid JSON file!');
        }
      };

      reader.readAsText(file);
    }

    // Function to download the JSON object as a file
    function downloadJson(jsonObj, name) {
      const jsonString = JSON.stringify(jsonObj, null, 2); // Convert JSON object to string
      const blob = new Blob([jsonString], { type: 'application/json' }); // Create a Blob
      const url = URL.createObjectURL(blob); // Create a URL for the Blob

      // Create a temporary anchor element to trigger the download
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name}`; // Set the filename with the fixed prefix
      document.body.appendChild(a);
      a.click(); // Trigger the download
      document.body.removeChild(a); // Clean up the DOM
      URL.revokeObjectURL(url); // Revoke the Blob URL
    }
  </script>
</body>

</html>